{"version":3,"sources":["../../src/utils/page-data.ts"],"names":["fixedPagePath","pagePath","getFilePath","publicDir","path","join","readPageData","filePath","rawPageData","fs","readFile","JSON","parse","removePageData","existsSync","remove","Promise","resolve","writePageData","componentChunkName","matchPath","inputFilePath","replace","outputFilePath","result","readJSON","body","bodyStr","stringify","pageDataSize","Buffer","byteLength","store","dispatch","type","payload","size","outputFile","isFlushPending","isFlushing","isFlushEnqueued","flush","pendingPageDataWrites","components","pages","program","getState","pagePaths","templatePaths","pagesToWrite","Array","from","reduce","set","componentPath","templateComponent","get","forEach","add","bind","Set","values","page","directory","_","websocketManager","emitPageData","id","enqueueFlush"],"mappings":";;;;;;;;;;;;;AAAA;;AACA;;AAEA;;AACA;;AACA;;AAcO,SAASA,aAAT,CAAuBC,QAAvB,EAAiD;AACtD,SAAOA,QAAQ,KAAM,GAAd,GAAoB,OAApB,GAA6BA,QAApC;AACD;;AAED,SAASC,WAAT,CAAqBC,SAArB,EAAwCF,QAAxC,EAAkE;AAChE,SAAOG,cAAKC,IAAL,CACLF,SADK,EAEJ,WAFI,EAGLH,aAAa,CAACC,QAAD,CAHR,EAIJ,gBAJI,CAAP;AAMD;;AAEM,eAAeK,YAAf,CACLH,SADK,EAELF,QAFK,EAG8B;AACnC,QAAMM,QAAQ,GAAGL,WAAW,CAACC,SAAD,EAAYF,QAAZ,CAA5B;AACA,QAAMO,WAAW,GAAG,MAAMC,iBAAGC,QAAH,CAAYH,QAAZ,EAAuB,OAAvB,CAA1B;AAEA,SAAOI,IAAI,CAACC,KAAL,CAAWJ,WAAX,CAAP;AACD;;AAEM,eAAeK,cAAf,CACLV,SADK,EAELF,QAFK,EAGU;AACf,QAAMM,QAAQ,GAAGL,WAAW,CAACC,SAAD,EAAYF,QAAZ,CAA5B;;AAEA,MAAIQ,iBAAGK,UAAH,CAAcP,QAAd,CAAJ,EAA6B;AAC3B,WAAO,MAAME,iBAAGM,MAAH,CAAUR,QAAV,CAAb;AACD;;AAED,SAAOS,OAAO,CAACC,OAAR,EAAP;AACD;;AAEM,eAAeC,aAAf,CACLf,SADK,EAEL;AAAEgB,EAAAA,kBAAF;AAAsBC,EAAAA,SAAtB;AAAiChB,EAAAA,IAAI,EAAEH;AAAvC,CAFK,EAG8B;AACnC,QAAMoB,aAAa,GAAGjB,cAAKC,IAAL,CACpBF,SADoB,EAEnB,IAFmB,EAGnB,QAHmB,EAInB,MAJmB,EAKnB,GAAEF,QAAQ,CAACqB,OAAT,CAAiB,KAAjB,EAAyB,GAAzB,CAA6B,OALZ,CAAtB;;AAOA,QAAMC,cAAc,GAAGrB,WAAW,CAACC,SAAD,EAAYF,QAAZ,CAAlC;AACA,QAAMuB,MAAM,GAAG,MAAMf,iBAAGgB,QAAH,CAAYJ,aAAZ,CAArB;AACA,QAAMK,IAAI,GAAG;AACXP,IAAAA,kBADW;AAEXf,IAAAA,IAAI,EAAEH,QAFK;AAGXmB,IAAAA,SAHW;AAIXI,IAAAA;AAJW,GAAb;AAMA,QAAMG,OAAO,GAAGhB,IAAI,CAACiB,SAAL,CAAeF,IAAf,CAAhB,CAhBmC,CAiBnC;;AACA,QAAMG,YAAY,GAAGC,MAAM,CAACC,UAAP,CAAkBJ,OAAlB,IAA6B,IAAlD;;AAEAK,eAAMC,QAAN,CAAe;AACbC,IAAAA,IAAI,EAAG,qBADM;AAEbC,IAAAA,OAAO,EAAE;AACP5B,MAAAA,QAAQ,EAAEgB,cADH;AAEPa,MAAAA,IAAI,EAAEP;AAFC;AAFI,GAAf;;AAQA,QAAMpB,iBAAG4B,UAAH,CAAcd,cAAd,EAA8BI,OAA9B,CAAN;AACA,SAAOD,IAAP;AACD;;AAED,IAAIY,cAAc,GAAG,KAArB;AACA,IAAIC,UAAU,GAAG,KAAjB;;AAEO,SAASC,eAAT,GAAoC;AACzC,SAAOF,cAAP;AACD;;AAEM,eAAeG,KAAf,GAAsC;AAC3C,MAAIF,UAAJ,EAAgB;AACd;AACA;AACD;;AACDD,EAAAA,cAAc,GAAG,KAAjB;AACAC,EAAAA,UAAU,GAAG,IAAb;;AACA,QAAM;AAAEG,IAAAA,qBAAF;AAAyBC,IAAAA,UAAzB;AAAqCC,IAAAA,KAArC;AAA4CC,IAAAA;AAA5C,MAAwDb,aAAMc,QAAN,EAA9D;;AAEA,QAAM;AAAEC,IAAAA,SAAF;AAAaC,IAAAA;AAAb,MAA+BN,qBAArC;AAEA,QAAMO,YAAY,GAAGC,KAAK,CAACC,IAAN,CAAWH,aAAX,EAA0BI,MAA1B,CACnB,CAACC,GAAD,EAAMC,aAAN,KAAwB;AACtB,UAAMC,iBAAiB,GAAGZ,UAAU,CAACa,GAAX,CAAeF,aAAf,CAA1B;;AACA,QAAIC,iBAAJ,EAAuB;AACrBA,MAAAA,iBAAiB,CAACX,KAAlB,CAAwBa,OAAxB,CAAgCJ,GAAG,CAACK,GAAJ,CAAQC,IAAR,CAAaN,GAAb,CAAhC;AACD;;AACD,WAAOA,GAAP;AACD,GAPkB,EAQnB,IAAIO,GAAJ,CAAQb,SAAS,CAACc,MAAV,EAAR,CARmB,CAArB;;AAWA,OAAK,MAAM5D,QAAX,IAAuBgD,YAAvB,EAAqC;AACnC,UAAMa,IAAI,GAAGlB,KAAK,CAACY,GAAN,CAAUvD,QAAV,CAAb,CADmC,CAGnC;AACA;AACA;AACA;AACA;AACA;;AACA,QAAI6D,IAAJ,EAAU;AAAA;;AACR,YAAMtC,MAAM,GAAG,MAAMN,aAAa,CAChCd,cAAKC,IAAL,CAAUwC,OAAO,CAACkB,SAAlB,EAA8B,QAA9B,CADgC,EAEhCD,IAFgC,CAAlC;;AAKA,UAAI,CAAAjB,OAAO,SAAP,IAAAA,OAAO,WAAP,0BAAAA,OAAO,CAAEmB,CAAT,0DAAa,CAAb,OAAqB,SAAzB,EAAmC;AACjCC,2CAAiBC,YAAjB,CAA8B;AAC5BC,UAAAA,EAAE,EAAElE,QADwB;AAE5BuB,UAAAA;AAF4B,SAA9B;AAID;AACF;AACF;;AAEDQ,eAAMC,QAAN,CAAe;AACbC,IAAAA,IAAI,EAAG;AADM,GAAf;;AAGAK,EAAAA,UAAU,GAAG,KAAb;AACA;AACD;;AAEM,SAAS6B,YAAT,GAA8B;AACnC,MAAI,4CAAJ,EAA8B;AAC5B9B,IAAAA,cAAc,GAAG,IAAjB;AACD,GAFD,MAEO;AACLG,IAAAA,KAAK;AACN;AACF","sourcesContent":["import fs from \"fs-extra\"\nimport path from \"path\"\nimport { IGatsbyPage } from \"../redux/types\"\nimport { websocketManager } from \"./websocket-manager\"\nimport { isWebpackStatusPending } from \"./webpack-status\"\nimport { store } from \"../redux\"\n\nimport { IExecutionResult } from \"../query/types\"\n\ninterface IPageData {\n  componentChunkName: IGatsbyPage[\"componentChunkName\"]\n  matchPath?: IGatsbyPage[\"matchPath\"]\n  path: IGatsbyPage[\"path\"]\n}\n\nexport interface IPageDataWithQueryResult extends IPageData {\n  result: IExecutionResult\n}\n\nexport function fixedPagePath(pagePath: string): string {\n  return pagePath === `/` ? `index` : pagePath\n}\n\nfunction getFilePath(publicDir: string, pagePath: string): string {\n  return path.join(\n    publicDir,\n    `page-data`,\n    fixedPagePath(pagePath),\n    `page-data.json`\n  )\n}\n\nexport async function readPageData(\n  publicDir: string,\n  pagePath: string\n): Promise<IPageDataWithQueryResult> {\n  const filePath = getFilePath(publicDir, pagePath)\n  const rawPageData = await fs.readFile(filePath, `utf-8`)\n\n  return JSON.parse(rawPageData)\n}\n\nexport async function removePageData(\n  publicDir: string,\n  pagePath: string\n): Promise<void> {\n  const filePath = getFilePath(publicDir, pagePath)\n\n  if (fs.existsSync(filePath)) {\n    return await fs.remove(filePath)\n  }\n\n  return Promise.resolve()\n}\n\nexport async function writePageData(\n  publicDir: string,\n  { componentChunkName, matchPath, path: pagePath }: IPageData\n): Promise<IPageDataWithQueryResult> {\n  const inputFilePath = path.join(\n    publicDir,\n    `..`,\n    `.cache`,\n    `json`,\n    `${pagePath.replace(/\\//g, `_`)}.json`\n  )\n  const outputFilePath = getFilePath(publicDir, pagePath)\n  const result = await fs.readJSON(inputFilePath)\n  const body = {\n    componentChunkName,\n    path: pagePath,\n    matchPath,\n    result,\n  }\n  const bodyStr = JSON.stringify(body)\n  // transform asset size to kB (from bytes) to fit 64 bit to numbers\n  const pageDataSize = Buffer.byteLength(bodyStr) / 1000\n\n  store.dispatch({\n    type: `ADD_PAGE_DATA_STATS`,\n    payload: {\n      filePath: outputFilePath,\n      size: pageDataSize,\n    },\n  })\n\n  await fs.outputFile(outputFilePath, bodyStr)\n  return body\n}\n\nlet isFlushPending = false\nlet isFlushing = false\n\nexport function isFlushEnqueued(): boolean {\n  return isFlushPending\n}\n\nexport async function flush(): Promise<void> {\n  if (isFlushing) {\n    // We're already in the middle of a flush\n    return\n  }\n  isFlushPending = false\n  isFlushing = true\n  const { pendingPageDataWrites, components, pages, program } = store.getState()\n\n  const { pagePaths, templatePaths } = pendingPageDataWrites\n\n  const pagesToWrite = Array.from(templatePaths).reduce(\n    (set, componentPath) => {\n      const templateComponent = components.get(componentPath)\n      if (templateComponent) {\n        templateComponent.pages.forEach(set.add.bind(set))\n      }\n      return set\n    },\n    new Set(pagePaths.values())\n  )\n\n  for (const pagePath of pagesToWrite) {\n    const page = pages.get(pagePath)\n\n    // It's a gloomy day in Bombay, let me tell you a short story...\n    // Once upon a time, writing page-data.json files were atomic\n    // After this change (#24808), they are not and this means that\n    // between adding a pending write for a page and actually flushing\n    // them, a page might not exist anymore щ（ﾟДﾟщ）\n    // This is why we need this check\n    if (page) {\n      const result = await writePageData(\n        path.join(program.directory, `public`),\n        page\n      )\n\n      if (program?._?.[0] === `develop`) {\n        websocketManager.emitPageData({\n          id: pagePath,\n          result,\n        })\n      }\n    }\n  }\n\n  store.dispatch({\n    type: `CLEAR_PENDING_PAGE_DATA_WRITES`,\n  })\n  isFlushing = false\n  return\n}\n\nexport function enqueueFlush(): void {\n  if (isWebpackStatusPending()) {\n    isFlushPending = true\n  } else {\n    flush()\n  }\n}\n"],"file":"page-data.js"}