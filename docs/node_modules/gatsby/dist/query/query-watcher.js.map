{"version":3,"sources":["../../src/query/query-watcher.js"],"names":["_","require","chokidar","path","slash","store","emitter","boundActionCreators","queryCompiler","default","report","queryUtil","debug","getQueriesSnapshot","state","getState","snapshot","components","Map","staticQueryComponents","handleComponentsWithRemovedQueries","queries","forEach","c","query","has","componentPath","dispatch","type","payload","id","deleteComponentsDependencies","handleQuery","component","isStaticQuery","oldQuery","get","isNewQuery","hash","text","replaceStaticQuery","name","enqueueExtractedQueryId","updateStateAndRunQueries","isFirstRun","parentSpan","then","size","queryExtracted","queriesWillNotRun","queryWillRun","watchComponent","warn","log","stripIndent","runQueuedQueries","clearInactiveComponents","pages","activeTemplates","Set","page","add","exports","extractQueries","process","env","NODE_ENV","watch","program","directory","filesToWatch","watcher","debounceCompile","debounce","rootDir","modulesThatUseGatsby","packagePaths","map","module","filesRegex","pathRegex","join","on","pendingActivity","filePath","startWatchDeletePage","action","otherPageWithTemplateExists","values"],"mappings":"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","sourcesContent":["/** *\n * Jobs of this module\n * - Maintain the list of components in the Redux store. So monitor new components\n *   and add/remove components.\n * - Watch components for query changes and extract these and update the store.\n * - Ensure all page queries are run as part of bootstrap and report back when\n *   this is done\n * - Whenever a query changes, re-run all pages that rely on this query.\n ***/\n\nconst _ = require(`lodash`)\nconst chokidar = require(`chokidar`)\n\nconst path = require(`path`)\nconst { slash } = require(`gatsby-core-utils`)\n\nconst { store, emitter } = require(`../redux/`)\nconst { boundActionCreators } = require(`../redux/actions`)\nconst queryCompiler = require(`./query-compiler`).default\nconst report = require(`gatsby-cli/lib/reporter`)\nconst queryUtil = require(`./index`)\nconst debug = require(`debug`)(`gatsby:query-watcher`)\nimport { getGatsbyDependents } from \"../utils/gatsby-dependents\"\n\nconst getQueriesSnapshot = () => {\n  const state = store.getState()\n\n  const snapshot = {\n    components: new Map(state.components),\n    staticQueryComponents: new Map(state.staticQueryComponents),\n  }\n\n  return snapshot\n}\n\nconst handleComponentsWithRemovedQueries = (\n  { components, staticQueryComponents },\n  queries\n) => {\n  // If a component had static query and it doesn't have it\n  // anymore - update the store\n  staticQueryComponents.forEach(c => {\n    if (c.query !== `` && !queries.has(c.componentPath)) {\n      debug(`Static query was removed from ${c.componentPath}`)\n      store.dispatch({\n        type: `REMOVE_STATIC_QUERY`,\n        payload: c.id,\n      })\n      boundActionCreators.deleteComponentsDependencies([c.id])\n    }\n  })\n}\n\nconst handleQuery = (\n  { components, staticQueryComponents },\n  query,\n  component\n) => {\n  // If this is a static query\n  // Add action / reducer + watch staticquery files\n  if (query.isStaticQuery) {\n    const oldQuery = staticQueryComponents.get(query.id)\n    const isNewQuery = !oldQuery\n\n    // Compare query text because text is compiled query with any attached\n    // fragments and we want to rerun queries if fragments are edited.\n    // Compare hash because hash is used for identyfing query and\n    // passing data to component in development. Hash can change if user will\n    // format query text, but it doesn't mean that compiled text will change.\n    if (\n      isNewQuery ||\n      oldQuery.hash !== query.hash ||\n      oldQuery.query !== query.text\n    ) {\n      boundActionCreators.replaceStaticQuery({\n        name: query.name,\n        componentPath: query.path,\n        id: query.id,\n        query: query.text,\n        hash: query.hash,\n      })\n\n      debug(\n        `Static query in ${component} ${\n          isNewQuery ? `was added` : `has changed`\n        }.`\n      )\n\n      boundActionCreators.deleteComponentsDependencies([query.id])\n      queryUtil.enqueueExtractedQueryId(query.id)\n    }\n    return true\n  }\n\n  return false\n}\n\nconst updateStateAndRunQueries = (isFirstRun, { parentSpan } = {}) => {\n  const snapshot = getQueriesSnapshot()\n  return queryCompiler({ parentSpan }).then(queries => {\n    // If there's an error while extracting queries, the queryCompiler returns false\n    // or zero results.\n    // Yeah, should probably be an error but don't feel like threading the error\n    // all the way here.\n    if (!queries || queries.size === 0) {\n      return null\n    }\n    handleComponentsWithRemovedQueries(snapshot, queries)\n\n    // Run action for each component\n    const { components } = snapshot\n    components.forEach(c => {\n      const { isStaticQuery = false, text = `` } =\n        queries.get(c.componentPath) || {}\n\n      boundActionCreators.queryExtracted({\n        componentPath: c.componentPath,\n        query: isStaticQuery ? `` : text,\n      })\n    })\n\n    let queriesWillNotRun = false\n    queries.forEach((query, component) => {\n      const queryWillRun = handleQuery(snapshot, query, component)\n\n      if (queryWillRun) {\n        watchComponent(component)\n        // Check if this is a page component.\n        // If it is and this is our first run during bootstrap,\n        // show a warning about having a query in a non-page component.\n      } else if (isFirstRun && !snapshot.components.has(component)) {\n        report.warn(\n          `The GraphQL query in the non-page component \"${component}\" will not be run.`\n        )\n        queriesWillNotRun = true\n      }\n    })\n\n    if (queriesWillNotRun) {\n      report.log(report.stripIndent`\n\n        Exported queries are only executed for Page components. It's possible you're\n        trying to create pages in your gatsby-node.js and that's failing for some\n        reason.\n\n        If the failing component(s) is a regular component and not intended to be a page\n        component, you generally want to use a <StaticQuery> (https://gatsbyjs.org/docs/static-query)\n        instead of exporting a page query.\n\n        If you're more experienced with GraphQL, you can also export GraphQL\n        fragments from components and compose the fragments in the Page component\n        query and pass data down into the child component — https://graphql.org/learn/queries/#fragments\n\n      `)\n    }\n\n    queryUtil.runQueuedQueries()\n\n    return null\n  })\n}\n\n/**\n * Removes components templates that aren't used by any page from redux store.\n */\nconst clearInactiveComponents = () => {\n  const { components, pages } = store.getState()\n\n  const activeTemplates = new Set()\n  pages.forEach(page => {\n    // Set will guarantee uniqueness of entries\n    activeTemplates.add(slash(page.component))\n  })\n\n  components.forEach(component => {\n    if (!activeTemplates.has(component.componentPath)) {\n      debug(\n        `${component.componentPath} component was removed because it isn't used by any page`\n      )\n      store.dispatch({\n        type: `REMOVE_TEMPLATE_COMPONENT`,\n        payload: component,\n      })\n    }\n  })\n}\n\nexports.extractQueries = ({ parentSpan } = {}) => {\n  // Remove template components that point to not existing page templates.\n  // We need to do this, because components data is cached and there might\n  // be changes applied when development server isn't running. This is needed\n  // only in initial run, because during development state will be adjusted.\n  clearInactiveComponents()\n\n  return updateStateAndRunQueries(true, { parentSpan }).then(() => {\n    // During development start watching files to recompile & run\n    // queries on the fly.\n    if (process.env.NODE_ENV !== `production`) {\n      watch(store.getState().program.directory)\n    }\n  })\n}\n\nconst filesToWatch = new Set()\nlet watcher\nconst watchComponent = componentPath => {\n  // We don't start watching until mid-way through the bootstrap so ignore\n  // new components being added until then. This doesn't affect anything as\n  // when extractQueries is called from bootstrap, we make sure that all\n  // components are being watched.\n  if (\n    process.env.NODE_ENV !== `production` &&\n    !filesToWatch.has(componentPath)\n  ) {\n    filesToWatch.add(componentPath)\n    if (watcher) {\n      watcher.add(componentPath)\n    }\n  }\n}\n\nconst debounceCompile = _.debounce(() => {\n  updateStateAndRunQueries()\n}, 100)\n\nconst watch = async rootDir => {\n  if (watcher) return\n\n  const modulesThatUseGatsby = await getGatsbyDependents()\n\n  const packagePaths = modulesThatUseGatsby.map(module => {\n    const filesRegex = `*.+(t|j)s?(x)`\n    const pathRegex = `/{${filesRegex},!(node_modules)/**/${filesRegex}}`\n    return slash(path.join(module.path, pathRegex))\n  })\n\n  watcher = chokidar\n    .watch([\n      slash(path.join(rootDir, `/src/**/*.{js,jsx,ts,tsx}`)),\n      ...packagePaths,\n    ])\n    .on(`change`, path => {\n      report.pendingActivity({ id: `query-extraction` })\n      debounceCompile()\n    })\n\n  filesToWatch.forEach(filePath => watcher.add(filePath))\n}\n\nexports.startWatchDeletePage = () => {\n  emitter.on(`DELETE_PAGE`, action => {\n    const componentPath = slash(action.payload.component)\n    const { pages } = store.getState()\n    let otherPageWithTemplateExists = false\n    for (let page of pages.values()) {\n      if (slash(page.component) === componentPath) {\n        otherPageWithTemplateExists = true\n        break\n      }\n    }\n    if (!otherPageWithTemplateExists) {\n      store.dispatch({\n        type: `REMOVE_TEMPLATE_COMPONENT`,\n        payload: {\n          componentPath,\n        },\n      })\n    }\n  })\n}\n\nexports.updateStateAndRunQueries = updateStateAndRunQueries\n"],"file":"query-watcher.js"}