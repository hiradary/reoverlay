{"version":3,"sources":["../../../src/redux/machines/page-component.ts"],"names":["defaultContext","isInBootstrap","componentPath","query","pages","Set","componentMachine","id","initial","context","on","BOOTSTRAP_FINISHED","actions","DELETE_PAGE","NEW_PAGE_CREATED","PAGE_CONTEXT_MODIFIED","QUERY_EXTRACTION_GRAPHQL_ERROR","QUERY_EXTRACTION_BABEL_ERROR","states","inactive","target","cond","inactiveWhileBootstrapping","QUERY_CHANGED","queryExtractionGraphQLError","QUERY_DID_NOT_CHANGE","queryExtractionBabelError","QUERY_EXTRACTION_BABEL_SUCCESS","runningPageQueries","onEntry","QUERIES_COMPLETE","idle","guards","isBootstrapping","isNotBootstrapping","rerunPageQuery","_ctx","event","queryUtil","require","setTimeout","enqueueExtractedQueryId","path","runPageComponentQueries","enqueueExtractedPageComponent","setQuery","ctx","setPage","runQueuedQueries","add","deletePage","delete","page","setBootstrapFinished"],"mappings":"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","sourcesContent":["import { Machine as machine, assign } from \"xstate\"\n\nexport interface IContext {\n  isInBootstrap: boolean\n  componentPath: string\n  query: string\n  pages: Set<string>\n}\n\nexport interface IState {\n  states: {\n    inactive: {}\n    inactiveWhileBootstrapping: {}\n    queryExtractionGraphQLError: {}\n    queryExtractionBabelError: {}\n    runningPageQueries: {}\n    idle: {}\n  }\n}\n\n/**\n * Stricter types for actions are not possible\n * as we have different payloads that would require casting.\n * The current approach prevents this but makes all payloads optional.\n * See https://github.com/gatsbyjs/gatsby/pull/23277#issuecomment-625425023\n */\n\ntype ActionTypes =\n  | \"BOOTSTRAP_FINISHED\"\n  | \"DELETE_PAGE\"\n  | \"NEW_PAGE_CREATED\"\n  | \"PAGE_CONTEXT_MODIFIED\"\n  | \"QUERY_EXTRACTION_GRAPHQL_ERROR\"\n  | \"QUERY_EXTRACTION_BABEL_ERROR\"\n  | \"QUERY_EXTRACTION_BABEL_SUCCESS\"\n  | \"QUERY_CHANGED\"\n  | \"QUERY_DID_NOT_CHANGE\"\n  | \"QUERIES_COMPLETE\"\n\nexport interface IEvent {\n  type: ActionTypes\n  path?: string\n  query?: string\n  page?: { path: string }\n}\n\nconst defaultContext: IContext = {\n  isInBootstrap: true,\n  componentPath: ``,\n  query: ``,\n  pages: new Set(``),\n}\n\nexport const componentMachine = machine<IContext, IState, IEvent>(\n  {\n    id: `pageComponents`,\n    initial: `inactive`,\n    context: defaultContext,\n    on: {\n      BOOTSTRAP_FINISHED: {\n        actions: `setBootstrapFinished`,\n      },\n      DELETE_PAGE: {\n        actions: `deletePage`,\n      },\n      NEW_PAGE_CREATED: {\n        actions: `setPage`,\n      },\n      PAGE_CONTEXT_MODIFIED: {\n        actions: `rerunPageQuery`,\n      },\n      QUERY_EXTRACTION_GRAPHQL_ERROR: `queryExtractionGraphQLError`,\n      QUERY_EXTRACTION_BABEL_ERROR: `queryExtractionBabelError`,\n    },\n    states: {\n      inactive: {\n        on: {\n          // Transient transition\n          // Will transition to either 'inactiveWhileBootstrapping' or idle\n          // immediately upon entering 'inactive' state if the condition is met.\n          \"\": [\n            { target: `inactiveWhileBootstrapping`, cond: `isBootstrapping` },\n            { target: `idle`, cond: `isNotBootstrapping` },\n          ],\n        },\n      },\n      inactiveWhileBootstrapping: {\n        on: {\n          BOOTSTRAP_FINISHED: {\n            target: `idle`,\n            actions: `setBootstrapFinished`,\n          },\n          QUERY_CHANGED: `runningPageQueries`,\n        },\n      },\n      queryExtractionGraphQLError: {\n        on: {\n          QUERY_DID_NOT_CHANGE: `idle`,\n          QUERY_CHANGED: `runningPageQueries`,\n        },\n      },\n      queryExtractionBabelError: {\n        on: {\n          QUERY_EXTRACTION_BABEL_SUCCESS: `idle`,\n        },\n      },\n      runningPageQueries: {\n        onEntry: [`setQuery`, `runPageComponentQueries`],\n        on: {\n          QUERIES_COMPLETE: `idle`,\n        },\n      },\n      idle: {\n        on: {\n          QUERY_CHANGED: `runningPageQueries`,\n        },\n      },\n    },\n  },\n  {\n    guards: {\n      isBootstrapping: (context): boolean => context.isInBootstrap,\n      isNotBootstrapping: (context): boolean => !context.isInBootstrap,\n    },\n    actions: {\n      rerunPageQuery: (_ctx, event): void => {\n        const queryUtil = require(`../../query`)\n        // Wait a bit as calling this function immediately triggers\n        // an Action call which Redux squawks about.\n        setTimeout(() => {\n          queryUtil.enqueueExtractedQueryId(event.path)\n        }, 0)\n      },\n      runPageComponentQueries: (context): void => {\n        const queryUtil = require(`../../query`)\n        // Wait a bit as calling this function immediately triggers\n        // an Action call which Redux squawks about.\n        setTimeout(() => {\n          queryUtil.enqueueExtractedPageComponent(context.componentPath)\n        }, 0)\n      },\n      setQuery: assign({\n        query: (ctx, event): string => {\n          if (typeof event.query !== `undefined` && event.query !== null) {\n            return event.query\n          } else {\n            return ctx.query\n          }\n        },\n      }),\n      setPage: assign({\n        pages: (ctx, event) => {\n          if (event.path) {\n            const queryUtil = require(`../../query`)\n            // Wait a bit as calling this function immediately triggers\n            // an Action call which Redux squawks about.\n            setTimeout(() => {\n              if (!ctx.isInBootstrap) {\n                queryUtil.enqueueExtractedQueryId(event.path)\n                queryUtil.runQueuedQueries(event.path)\n              }\n            }, 0)\n            ctx.pages.add(event.path)\n            return ctx.pages\n          } else {\n            return ctx.pages\n          }\n        },\n      }),\n      deletePage: assign({\n        pages: (ctx, event) => {\n          ctx.pages.delete(event.page!.path)\n          return ctx.pages\n        },\n      }),\n      setBootstrapFinished: assign<IContext>({\n        isInBootstrap: false,\n      }),\n    },\n  }\n)\n"],"file":"page-component.js"}